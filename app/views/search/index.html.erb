<% content_for :title, "Search" %>
<div class="container">
  <div class="search-page">
    <h1>Search</h1>

    <%= form_with url: search_path, method: :get, local: true, class: "search-form",
                  data: { controller: "autocomplete", autocomplete_url_value: search_autocomplete_path, action: "click@window->autocomplete#clickOutside" } do |f| %>
      <div class="search-input-wrapper">
        <%= f.text_field :q, value: @query, placeholder: "Search movies, cinemas, people, genres ...",
                         class: "search-input", autocomplete: "off",
                         data: { autocomplete_target: "input", action: "input->autocomplete#search keydown->autocomplete#handleEscape" } %>

        <div class="autocomplete-results" data-autocomplete-target="results"></div>
      </div>

      <%= f.submit "Search", class: "search-button" %>
    <% end %>

    <% if @query.present? %>
      <% if @results.values.flatten.any? %>

        <!-- Movies -->
        <% current_movies = @results[:movies_current].to_a %>
        <% archived_movies = @results[:movies_archived].to_a %>
        <% if current_movies.any? || archived_movies.any? %>
          <div class="search-section">
            <h2>Movies (<%= current_movies.count + archived_movies.count %>)</h2>

            <% if current_movies.any? %>
              <div class="genre-movies-section" data-controller="toggle" data-toggle-count-value="<%= [current_movies.count - 10, 0].max %>" data-toggle-current-section-value="true">
                <h4 class="subsection-title">
                  <span class="badge badge-success">Currently Showing</span>
                  (<%= current_movies.count %>)
                </h4>
                <div class="results-list">
                  <% current_movies.first(10).each do |movie| %>
                    <div class="result-item">
                      <%= link_to movie_path(movie) do %>
                        <h3><%= highlight_search_term(movie.title, @query) %></h3>
                        <% if movie.description.present? %>
                          <p><%= highlight_search_term(movie.description, @query, length: 150) %></p>
                        <% end %>
                        <% if movie.year.present? %>
                          <span class="meta"><%= movie.year %></span>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                  <% if current_movies.count > 10 %>
                    <div data-toggle-target="content" style="display: none;">
                      <% current_movies.drop(10).each do |movie| %>
                        <div class="result-item">
                          <%= link_to movie_path(movie) do %>
                            <h3><%= highlight_search_term(movie.title, @query) %></h3>
                            <% if movie.description.present? %>
                              <p><%= highlight_search_term(movie.description, @query, length: 150) %></p>
                            <% end %>
                            <% if movie.year.present? %>
                              <span class="meta"><%= movie.year %></span>
                            <% end %>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                    <button class="toggle-movies-btn" data-toggle-target="button" data-action="click->toggle#toggle">
                      Show <%= current_movies.count - 10 %> more currently showing
                    </button>
                  <% end %>
                </div>
              </div>
            <% end %>

            <% if archived_movies.any? %>
              <div class="genre-movies-section" data-controller="toggle" data-toggle-count-value="<%= [archived_movies.count - 10, 0].max %>">
                <h4 class="subsection-title">
                  <span class="badge badge-secondary">All Movies</span>
                  (<%= archived_movies.count %>)
                </h4>
                <div class="results-list">
                  <% archived_movies.first(10).each do |movie| %>
                    <div class="result-item">
                      <%= link_to movie_path(movie) do %>
                        <h3><%= highlight_search_term(movie.title, @query) %></h3>
                        <% if movie.description.present? %>
                          <p><%= highlight_search_term(movie.description, @query, length: 150) %></p>
                        <% end %>
                        <% if movie.year.present? %>
                          <span class="meta"><%= movie.year %></span>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                  <% if archived_movies.count > 10 %>
                    <div data-toggle-target="content" style="display: none;">
                      <% archived_movies.drop(10).each do |movie| %>
                        <div class="result-item">
                          <%= link_to movie_path(movie) do %>
                            <h3><%= highlight_search_term(movie.title, @query) %></h3>
                            <% if movie.description.present? %>
                              <p><%= highlight_search_term(movie.description, @query, length: 150) %></p>
                            <% end %>
                            <% if movie.year.present? %>
                              <span class="meta"><%= movie.year %></span>
                            <% end %>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                    <button class="toggle-movies-btn" data-toggle-target="button" data-action="click->toggle#toggle">
                      Show <%= archived_movies.count - 10 %> more
                    </button>
                  <% end %>
                </div>
              </div>
            <% end %>

          </div>
        <% end %>

        <!-- Cinemas -->
        <% cinemas = @results[:cinemas].to_a %>
        <% if cinemas.any? %>
          <div class="search-section" data-controller="toggle" data-toggle-count-value="<%= [cinemas.count - 10, 0].max %>">
            <h2>Cinemas (<%= cinemas.count %>)</h2>
            <div class="results-list">
              <% cinemas.first(10).each do |cinema| %>
                <div class="result-item">
                  <%= link_to cinema_path(cinema) do %>
                    <h3><%= highlight_search_term(cinema.title, @query) %></h3>
                    <% if cinema.street.present? %>
                      <p><%= cinema.street %></p>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
              <% if cinemas.count > 10 %>
                <div data-toggle-target="content" style="display: none;">
                  <% cinemas.drop(10).each do |cinema| %>
                    <div class="result-item">
                      <%= link_to cinema_path(cinema) do %>
                        <h3><%= highlight_search_term(cinema.title, @query) %></h3>
                        <% if cinema.street.present? %>
                          <p><%= cinema.street %></p>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
                <button class="toggle-movies-btn" data-toggle-target="button" data-action="click->toggle#toggle">
                  Show <%= cinemas.count - 10 %> more
                </button>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- People -->
        <% people = @results[:people].to_a %>
        <% if people.any? %>
          <div class="search-section" data-controller="toggle" data-toggle-count-value="<%= [people.count - 10, 0].max %>">
            <h2>People (<%= people.count %>)</h2>
            <div class="results-list">
              <% people.first(10).each do |person| %>
                <div class="result-item">
                  <div class="person-header">
                    <h3><%= highlight_search_term(person.name, @query) %></h3>
                    <p class="meta">
                      <%= person.credits.where(role: 'cast').count %> acting credits,
                      <%= person.credits.where(role: 'crew', job: 'Director').count %> directing credits
                    </p>
                  </div>
                  <% person_movies = person.movies.distinct.limit(5) %>
                  <% if person_movies.any? %>
                    <div class="associated-movies">
                      <strong>Movies:</strong>
                      <%= person_movies.map { |m| link_to(m.title, movie_path(m)) }.join(', ').html_safe %>
                      <% if person.movies.count > 5 %>
                        <span class="more">+ <%= person.movies.count - 5 %> more</span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
              <% if people.count > 10 %>
                <div data-toggle-target="content" style="display: none;">
                  <% people.drop(10).each do |person| %>
                    <div class="result-item">
                      <div class="person-header">
                        <h3><%= highlight_search_term(person.name, @query) %></h3>
                        <p class="meta">
                          <%= person.credits.where(role: 'cast').count %> acting credits,
                          <%= person.credits.where(role: 'crew', job: 'Director').count %> directing credits
                        </p>
                      </div>
                      <% person_movies = person.movies.distinct.limit(5) %>
                      <% if person_movies.any? %>
                        <div class="associated-movies">
                          <strong>Movies:</strong>
                          <%= person_movies.map { |m| link_to(m.title, movie_path(m)) }.join(', ').html_safe %>
                          <% if person.movies.count > 5 %>
                            <span class="more">+ <%= person.movies.count - 5 %> more</span>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
                <button class="toggle-movies-btn" data-toggle-target="button" data-action="click->toggle#toggle">
                  Show <%= people.count - 10 %> more
                </button>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Genres -->
        <% if @results[:genres].any? %>
          <div class="search-section">
            <h2>Genres (<%= @results[:genres].count %>)</h2>
            <div class="results-list">
              <% @results[:genres].each do |genre| %>
                <div class="result-item genre-result">
                  <div class="genre-header">
                    <h3><%= highlight_search_term(genre.name, @query) %></h3>
                    <p class="meta"><%= genre.movies.count %> total movies</p>
                  </div>

                  <% current_movies = genre.currently_showing_movies %>
                  <% archived_movies = genre.archived_movies %>

                  <!-- Currently Showing Movies -->
                  <% if current_movies.any? %>
                    <div class="genre-movies-section" data-controller="toggle" data-toggle-count-value="<%= current_movies.count - 10 %>" data-toggle-current-section-value="true">
                      <h4 class="subsection-title">
                        <span class="badge badge-success">Currently Showing</span>
                        (<%= current_movies.count %>)
                      </h4>

                      <div class="genre-movies">
                        <ul class="movie-list">
                          <% current_movies.limit(10).each do |movie| %>
                            <li class="movie-item-current">
                              <%= link_to movie_path(movie) do %>
                                <span class="movie-title"><%= movie.title %></span>
                                <% if movie.year.present? %>
                                  <span class="movie-year">(<%= movie.year %>)</span>
                                <% end %>
                              <% end %>
                            </li>
                          <% end %>
                        </ul>

                        <% if current_movies.count > 10 %>
                          <ul class="movie-list remaining-movies" data-toggle-target="content" style="display: none;">
                            <% current_movies.offset(10).each do |movie| %>
                              <li class="movie-item-current">
                                <%= link_to movie_path(movie) do %>
                                  <span class="movie-title"><%= movie.title %></span>
                                  <% if movie.year.present? %>
                                    <span class="movie-year">(<%= movie.year %>)</span>
                                  <% end %>
                                <% end %>
                              </li>
                            <% end %>
                          </ul>

                          <button class="toggle-movies-btn" data-toggle-target="button" data-action="click->toggle#toggle">
                            Show <%= current_movies.count - 10 %> more currently showing
                          </button>
                        <% end %>
                      </div>
                    </div>
                  <% end %>

                  <!-- Archived/Not Currently Showing Movies -->
                  <% if archived_movies.any? %>
                    <div class="genre-movies-section" data-controller="toggle" data-toggle-count-value="<%= archived_movies.count - 10 %>">
                      <h4 class="subsection-title">
                        <span class="badge badge-secondary">All Movies</span>
                        (<%= archived_movies.count %>)
                      </h4>

                      <div class="genre-movies">
                        <ul class="movie-list">
                          <% archived_movies.limit(10).each do |movie| %>
                            <li>
                              <%= link_to movie_path(movie) do %>
                                <span class="movie-title"><%= movie.title %></span>
                                <% if movie.year.present? %>
                                  <span class="movie-year">(<%= movie.year %>)</span>
                                <% end %>
                              <% end %>
                            </li>
                          <% end %>
                        </ul>

                        <% if archived_movies.count > 10 %>
                          <ul class="movie-list remaining-movies" data-toggle-target="content" style="display: none;">
                            <% archived_movies.offset(10).each do |movie| %>
                              <li>
                                <%= link_to movie_path(movie) do %>
                                  <span class="movie-title"><%= movie.title %></span>
                                  <% if movie.year.present? %>
                                    <span class="movie-year">(<%= movie.year %>)</span>
                                  <% end %>
                                <% end %>
                              </li>
                            <% end %>
                          </ul>

                          <button class="toggle-movies-btn" data-toggle-target="button" data-action="click->toggle#toggle">
                            Show <%= archived_movies.count - 10 %> more
                          </button>
                        <% end %>
                      </div>
                    </div>
                  <% end %>

                </div>
              <% end %>
            </div>
          </div>
        <% end %>

      <% else %>
        <p class="no-results">No results found for "<%= @query %>"</p>
      <% end %>
    <% end %>
  </div>
</div>
