<% content_for :title, "Crawler Dashboard" %>

<div class="container mt-3 pt-2">
  <h2 class="mb-1">Dashboard</h2>

  <%# ── Page view stats ─────────────────────────────────────────────── %>
  <h5 class="mt-4 mb-3">Page views <span class="text-muted fw-normal fs-6">(humans only)</span></h5>
  <div class="row g-3 mb-3">
    <div class="col-sm-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="fs-3 fw-bold"><%= @views_today %></div>
          <div class="text-muted small">Today</div>
        </div>
      </div>
    </div>
    <div class="col-sm-3">
      <div class="card text-center border-secondary">
        <div class="card-body">
          <div class="fs-3 fw-bold text-secondary"><%= @bots_today %></div>
          <div class="text-muted small">Bots today</div>
        </div>
      </div>
    </div>
    <div class="col-sm-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="fs-3 fw-bold"><%= @views_7_days %></div>
          <div class="text-muted small">Last 7 days</div>
        </div>
      </div>
    </div>
    <div class="col-sm-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="fs-3 fw-bold"><%= @views_30_days %></div>
          <div class="text-muted small">Last 30 days</div>
        </div>
      </div>
    </div>
  </div>

  <% if @daily_counts.any? %>
    <table class="table table-sm table-bordered mb-4" style="width:auto">
      <thead class="table-light">
        <tr>
          <% @daily_counts.each_key do |date| %>
            <th class="text-center small"><%= Date.parse(date.to_s).strftime("%d.%m.") %></th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <tr>
          <% @daily_counts.each_value do |count| %>
            <td class="text-center"><%= count %></td>
          <% end %>
        </tr>
      </tbody>
    </table>
  <% end %>

  <div class="row g-4 mb-5">
    <div class="col-md-4">
      <h6 class="text-muted text-uppercase small mb-2">Top movies (30 days)</h6>
      <% if @top_movies.any? %>
        <ol class="mb-0">
          <% @top_movies.each do |movie, count| %>
            <li><%= movie.title %> <span class="text-muted small">(<%= count %>)</span></li>
          <% end %>
        </ol>
      <% else %>
        <p class="text-muted small">No data yet.</p>
      <% end %>
    </div>
    <div class="col-md-4">
      <h6 class="text-muted text-uppercase small mb-2">Top cinemas (30 days)</h6>
      <% if @top_cinemas.any? %>
        <ol class="mb-0">
          <% @top_cinemas.each do |cinema, count| %>
            <li><%= cinema.title %> <span class="text-muted small">(<%= count %>)</span></li>
          <% end %>
        </ol>
      <% else %>
        <p class="text-muted small">No data yet.</p>
      <% end %>
    </div>
    <div class="col-md-4">
      <h6 class="text-muted text-uppercase small mb-2">Views by county (30 days)</h6>
      <% if @views_by_county.any? %>
        <ul class="list-unstyled mb-0">
          <% @views_by_county.each do |county, count| %>
            <li><%= county %> <span class="text-muted small">(<%= count %>)</span></li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-muted small">No data yet.</p>
      <% end %>
    </div>
  </div>

  <hr class="mb-4">

  <%# ── Crawler runs ────────────────────────────────────────────────── %>
  <h5 class="mb-3">Crawler runs</h5>
  <p class="text-muted mb-4">Last <%= @runs.size %> runs</p>

  <% if @runs.empty? %>
    <p class="text-muted">No crawler runs recorded yet.</p>
  <% else %>
    <%
      total     = @runs.size
      failed    = @runs.count(&:failed?)
      succeeded = total - failed
      last_run  = @runs.first
    %>

    <div class="row g-3 mb-4">
      <div class="col-sm-4">
        <div class="card text-center">
          <div class="card-body">
            <div class="fs-3 fw-bold"><%= total %></div>
            <div class="text-muted small">Runs recorded</div>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card text-center border-success">
          <div class="card-body">
            <div class="fs-3 fw-bold text-success"><%= succeeded %></div>
            <div class="text-muted small">Successful</div>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card text-center <%= failed > 0 ? 'border-danger' : '' %>">
          <div class="card-body">
            <div class="fs-3 fw-bold <%= failed > 0 ? 'text-danger' : 'text-muted' %>"><%= failed %></div>
            <div class="text-muted small">With failures</div>
          </div>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <strong>Last run:</strong>
      <%= last_run.ran_at.strftime("%d.%m.%Y %H:%M") %>
      <% if last_run.success? %>
        <span class="badge bg-success ms-2">OK</span>
      <% else %>
        <span class="badge bg-danger ms-2"><%= last_run.failures.size %> failure(s)</span>
      <% end %>
    </div>

    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Run at</th>
          <th>Crawlers</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @runs.each do |run| %>
          <tr class="<%= run.failed? ? 'table-danger' : 'table-success' %>">
            <td><%= run.ran_at.strftime("%d.%m.%Y %H:%M") %></td>
            <td><%= run.crawler_count %></td>
            <td>
              <% if run.success? %>
                <span class="badge bg-success">OK</span>
              <% else %>
                <span class="badge bg-danger"><%= run.failures.size %> failed</span>
              <% end %>
            </td>
            <td>
              <% if run.failed? %>
                <a class="btn btn-sm btn-outline-danger"
                   data-bs-toggle="collapse"
                   href="#run-<%= run.id %>">
                  Details
                </a>
              <% end %>
            </td>
          </tr>
          <% if run.failed? %>
            <tr class="collapse" id="run-<%= run.id %>">
              <td colspan="4" class="bg-light">
                <% run.failures.each do |f| %>
                  <div class="mb-3">
                    <strong><%= f["crawler"] %></strong>
                    <div class="text-danger"><%= f["error"] %></div>
                    <% if f["backtrace"].present? %>
                      <pre class="mt-1 p-2 bg-white border rounded small"><%= f["backtrace"].join("\n") %></pre>
                    <% end %>
                  </div>
                <% end %>
              </td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  <% end %>
</div>
